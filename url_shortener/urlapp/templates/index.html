<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
</head>
<body>

    <div class="card">
        <div class="card-header">
            URL shortener
        </div>
        <div class="card-body">
            <h5 class="card-title">Paste your URL below:</h5>
            
            <form method="POST" action="{% url 'create' %}" id = "form">
                {% csrf_token %}
                <input type="text" class="input-group-text mb-3" id="url" name="link">
                <button type="submit" class="btn btn-primary mb-3" id="submit_button">Shorten <i class="bi bi-code"></i></button>
            </form>
            
            <div id="shortened_link"></div>
        </div>
    </div>

    <script>
        let form = document.getElementById("form");
let shortened_link = document.getElementById('shortened_link');
form.addEventListener('submit', shortenURL);

function shortenURL(e) {
    e.preventDefault();
    const csrfToken = getCookie('csrftoken');
    $.ajax({
        type: 'POST',
        url: form.action,
        data: $(form).serialize() + "&csrfmiddlewaretoken=" + csrfToken,
        dataType: "text", // Expecting plain text
        success: function(data) {
            console.log("Shortened link ID received:", data);
            shortened_link.innerText = "Your shortened URL is: http://127.0.0.1:8000/" + data;
        },
        error: function(xhr, status, error) {
            console.error("AJAX Error:", status, error, xhr);
        }
    });
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            let cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
    </script>

</body>
</html>